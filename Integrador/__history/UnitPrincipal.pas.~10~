unit UnitPrincipal;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, FireDAC.Stan.Intf, FireDAC.Stan.Option,
  FireDAC.Stan.Error, FireDAC.UI.Intf, FireDAC.Phys.Intf, FireDAC.Stan.Def,
  FireDAC.Phys, FireDAC.Stan.Pool, FireDAC.Stan.Async, FireDAC.VCLUI.Wait,
  FireDAC.Comp.Client, Data.DB, FireDAC.Phys.MySQL, FireDAC.Phys.MySQLDef,
  IdAuthentication, IdBaseComponent, IdComponent, IdTCPConnection, IdTCPClient,
  IdHTTP, Vcl.StdCtrls, Vcl.Grids, Vcl.DBGrids, Vcl.ExtCtrls, Datasnap.DBClient, System.JSON,
  Vcl.Buttons, Vcl.ComCtrls, Vcl.CustomizeDlg, System.ImageList, Vcl.ImgList,
  System.Win.TaskbarCore, Vcl.Taskbar, Vcl.DBCtrls, Vcl.Mask, UnitDmPrincipal;

type
  TfrmPrincipal = class(TForm)
    IdHTTP1: TIdHTTP;
    Panel1: TPanel;
    Label1: TLabel;
    Paginas: TPageControl;
    Review: TTabSheet;
    Panel2: TPanel;
    dbProduto: TDBGrid;
    Panel3: TPanel;
    dbCores: TDBGrid;
    Cadastro: TTabSheet;
    Panel4: TPanel;
    OpenDialog: TOpenDialog;
    Panel5: TPanel;
    Label5: TLabel;
    Label6: TLabel;
    RadioGroup2: TRadioGroup;
    SpeedButton1: TSpeedButton;
    Label7: TLabel;
    RadioGroup1: TRadioGroup;
    Label2: TLabel;
    Label3: TLabel;
    Label9: TLabel;
    Label4: TLabel;
    Navegador: TDBNavigator;
    SpeedButton2: TSpeedButton;
    btnSalvar: TSpeedButton;
    btnDeletar: TSpeedButton;
    edtURLImagemProduto: TEdit;
    edtURLImagemCor: TEdit;
    edtDescricaoProduto: TEdit;
    edtDescricaoCor: TEdit;
    edtPreco: TEdit;
    procedure FormCreate(Sender: TObject);
    procedure SpeedButton2Click(Sender: TObject);
    procedure btnSalvarClick(Sender: TObject);
    procedure SpeedButton1Click(Sender: TObject);
  private
    procedure PreencheCDSProduto(const JSONString: string);
    procedure GravarProdutos;
    { Private declarations }
  public
    { Public declarations }
  end;

var
  frmPrincipal: TfrmPrincipal;
  IdHTTP: TIdHTTP;
  Response: string;
  JSONObj: TJSONObject;
  CoresArray: TJSONArray;
  Cor: TJSONValue;
  const urlListaProduto = 'http://localhost:8080/produtos/listagemProdutos';
  const urlGravarProduto = 'http://localhost:8080/produtos/gravarProduto';

implementation

{$R *.dfm}


procedure TfrmPrincipal.btnSalvarClick(Sender: TObject);
begin
  GravarProdutos;
end;

procedure TfrmPrincipal.FormCreate(Sender: TObject);
begin
  IdHTTP := TIdHTTP.Create(nil);

  try
    Response := IdHTTP.Get(urlListaProduto);
  finally
    IdHTTP.Free;
  end;

  PreencheCDSProduto(Response);
end;

procedure TfrmPrincipal.GravarProdutos;
var
  JSONToSend: TJSONObject;
  JSONArrayProdutos, JSONArrayCores: TJSONArray;
  JSONProduto, JSONCor: TJSONObject;
  JSONString: string;
  Stream: TStringStream;

begin
  IdHTTP := TIdHTTP.Create(nil);
  JSONToSend := TJSONObject.Create;
  JSONArrayProdutos := TJSONArray.Create;
  JSONArrayCores := TJSONArray.Create;

  if not dmPrincipal.CdsProduto.Locate('descricao', dmPrincipal.cdsProdutoDESCRICAO.Value, []) then
    dmPrincipal.CdsCadastroProduto.Append
  else
    dmPrincipal.CdsCadastroProduto.Edit;

  JSONProduto := TJSONObject.Create;
  JSONProduto.AddPair('id', IntToStr(dmPrincipal.CdsCadastroProdutoID.Value));
  JSONProduto.AddPair('descricao', edtDescricaoProduto.Text);
  JSONProduto.AddPair('precoUnitario', edtPreco.Text);
  JSONProduto.AddPair('imagem', edtURLImagemProduto.Text);

  if edtDescricaoCor.Text <> '' then
  begin
    JSONArrayCores := TJSONArray.Create;
    dmPrincipal.cdsCores.Filter := 'PRODUTO_ID = ' + IntToStr(dmPrincipal.cdsProdutoID.Value);

    JSONCor := TJSONObject.Create;
    if not dmPrincipal.cdsCores.Locate('descricao', dmPrincipal.cdsCoresDESCRICAO.Value, []) then
      dmPrincipal.CdsCadastroCor.Append
    else
      dmPrincipal.CdsCadastroCor.Edit;

    JSONCor.AddPair('id', IntToStr(dmPrincipal.CdsCadastroCorID.Value));
    JSONCor.AddPair('descricao', edtDescricaoCor.Text);
    JSONCor.AddPair('imagem', edtURLImagemCor.Text);
    JSONArrayCores.AddElement(JSONCor);
    JSONProduto.AddPair('cores', JSONArrayCores);
  end;
  ShowMessage(JSONArrayCores.Items[0].ToString);
  JSONArrayProdutos.AddElement(JSONProduto);
  Stream := TStringStream.Create(JSONArrayProdutos.Items[0].ToString, TEncoding.UTF8);

  try
    IdHTTP.Request.ContentType := 'application/json';
    IdHTTP.Post(urlGravarProduto, Stream);
  finally
    Stream.Free;
    dmPrincipal.CdsCadastroCor.EmptyDataSet;
    dmPrincipal.CdsCadastroProduto.EmptyDataSet;
  end;
end;

procedure TfrmPrincipal.PreencheCDSProduto(const JSONString: string);
var JSONArray: TJSONArray;
    JSONValue: TJSONValue;
    JSONObj: TJSONObject;
    CoresArray: TJSONArray;
    Cor: TJSONValue;
begin
  JSONArray := TJSONObject.ParseJSONValue(JSONString) as TJSONArray;

  try
    for JSONValue in JSONArray do
    begin
      if JSONValue is TJSONObject then
      begin
        JSONObj := JSONValue as TJSONObject;

        if not dmPrincipal.CdsProduto.Locate('ID', StrToInt(JSONObj.GetValue('id').Value), []) then
          dmPrincipal.cdsProduto.Append
        else
          dmPrincipal.cdsProduto.Edit;

        dmPrincipal.CdsProdutoID.Value := StrToIntDef(JSONObj.GetValue('id').Value, 0);
        dmPrincipal.CdsProdutoDESCRICAO.Value := JSONObj.GetValue('descricao').Value;
        dmPrincipal.CdsProdutoPRECO.Value := StrToFloatDef(JSONObj.GetValue('precoUnitario').Value, 0.0);
        dmPrincipal.CdsProdutoIMAGEM.Value := JSONObj.GetValue('imagem').Value;
        dmPrincipal.cdsProduto.Post;

        dmPrincipal.cdsCores.EmptyDataSet;
        CoresArray := JSONObj.GetValue('cores') as TJSONArray;

        for Cor in CoresArray do
        begin
          dmPrincipal.cdsCores.Append;
          dmPrincipal.cdsCores.FieldByName('Cor').AsString := Cor.Value;
          dmPrincipal.cdsCores.Post;
        end;
      end;
    end;
  finally
    JSONArray.Free;
  end;
end;

procedure TfrmPrincipal.SpeedButton1Click(Sender: TObject);
begin
  if OpenDialog.Execute then
    edtURLImagemCor.Text := OpenDialog.FileName;
end;

procedure TfrmPrincipal.SpeedButton2Click(Sender: TObject);
begin
  if OpenDialog.Execute then
    edtURLImagemProduto.Text := OpenDialog.FileName;
end;

end.
